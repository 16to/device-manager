# 设备数量限制功能说明

## 功能概述
新增了系统管理员可配置的用户最多占用设备数量限制功能，默认每个用户最多可以占用1台设备。

## 主要更新

### 1. 配置文件 (config.json)
- 添加了 `device.max_devices_per_user` 配置项，默认值为 1
- 管理员可通过前端界面或直接修改配置文件来调整此限制

### 2. 后端更新 (backend/app.py)

#### 新增API端点
- **GET /api/config** - 返回配置时包含设备限制信息
- **PUT /api/config/device/limit** - 管理员可更新设备数量限制

#### 占用设备逻辑增强
在 `occupy_device()` 函数中添加了数量限制检查：
- 在允许用户占用设备前，先查询该用户当前已占用的设备数量
- 如果达到或超过限制，返回403错误，并提示用户先释放其他设备
- 错误消息包含当前占用数量和最大限制数量

### 3. 前端更新 (frontend/index.html)

#### 配置管理界面
- 在页面标题旁添加"设备限制"按钮（仅管理员可见）
- 显示当前限制：`设备限制: X台/人`
- 点击可弹出对话框修改限制值
- 限制必须是大于等于1的整数

#### 占用设备对话框增强
- 在账号输入框下方显示用户当前已占用设备数量和限制
- 格式：`当前已占用 X/Y 台设备`
- 当已达到限制时，显示红色警告提示
- 未达到限制时，显示绿色通过提示

#### 新增方法
- `getCurrentOccupiedCount()` - 计算当前用户已占用的设备数量
- `editDeviceLimit()` - 编辑设备数量限制（管理员）
- `updateDeviceLimit()` - 更新设备数量限制到后端

## 使用说明

### 管理员配置限制
1. 以管理员身份登录系统
2. 在页面顶部标题旁找到"设备限制: X台/人"按钮
3. 点击按钮，在弹出的输入框中输入新的限制数量（必须≥1）
4. 确认后，配置立即生效并保存到配置文件

### 用户占用设备
1. 登录后点击"占用"按钮
2. 在占用设备对话框中，可以看到当前已占用的设备数量
3. 如果已达到限制，无法继续占用新设备，需先释放已占用的设备
4. 后端会在提交时再次验证，防止并发问题

## 错误提示示例

当用户尝试占用超过限制数量的设备时：
```
您已占用 1 台设备，达到最大限制 1 台。请先释放其他设备后再占用。
```

## 技术细节

- 限制检查在后端执行，确保数据安全
- 前端实时显示当前占用数量，提供良好的用户体验
- 配置持久化到 config.json 文件
- 支持热更新，无需重启服务即可生效
- 管理员不受此限制约束（管理员可以代表任意用户占用设备）

## 默认配置

```json
{
  "device": {
    "max_devices_per_user": 1
  }
}
```

如果配置文件中没有此项，系统会使用默认值 1。
