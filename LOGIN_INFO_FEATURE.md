# Linux登录信息获取功能

## 功能说明

在用户占用设备时，系统会自动通过SSH连接到设备，执行以下命令获取完整的Linux登录情况：
- `who` - 显示当前登录的用户
- `who -a` - 显示更详细的当前登录信息
- `w` - 显示登录用户及其活动信息
- `last -n 30 -a` - 显示最近30次登录历史（包含用户名、IP地址、登录时间等）
- `lastlog | head -n 50` - 显示所有用户的最后登录信息

获取到的登录信息会保存到使用记录中，方便后续查看设备的历史使用状态和用户登录记录。

## 使用方法

### 1. 占用设备
当用户占用设备时，系统会自动：
1. 使用设备的SSH连接配置（第一个SSH连接）
2. 连接到Linux设备
3. 执行 `who` 和 `w` 命令获取登录信息
4. 将信息保存到使用记录的 `login_info` 字段

### 2. 查看登录信息
1. 进入 **使用记录** 页面
2. 在记录列表中找到想要查看的记录
3. 点击 **"🖥️ 查看"** 按钮
4. 在弹出的窗口中查看Linux登录信息

## 技术实现

### 后端实现
1. **模型更新** (`backend/models.py`)
   - 在 `UsageRecord` 模型中添加了 `login_info` 字段（TEXT类型）

2. **获取登录信息函数** (`backend/app.py`)
   ```python
   def get_linux_login_info(device):
       """通过SSH获取Linux登录信息"""
       # 使用paramiko SSH客户端连接设备
       # 执行多个命令获取完整信息：
       # - who: 当前登录用户
       # - who -a: 详细当前登录信息
       # - w: 用户活动
       # - last -n 30 -a: 最近30次登录历史（含IP）
       # - lastlog: 所有用户最后登录信息
       # 返回组合的登录信息
   ```

3. **占用设备API更新**
   - 在 `occupy_device` 函数中调用 `get_linux_login_info`
   - 将获取的信息保存到 `UsageRecord` 中

### 前端实现
1. **显示查看按钮** (`frontend/index.html`)
   - 在使用记录表格中添加 "登录信息" 列
   - 显示 "🖥️ 查看" 按钮

2. **登录信息弹窗**
   - 添加模态框显示登录信息
   - 使用 `<pre>` 标签格式化显示命令输出

3. **查看功能**
   ```javascript
   showLoginInfo(record) {
       // 显示登录信息弹窗
   }
   ```

## 错误处理

如果SSH连接失败或命令执行失败：
- 系统会在 `login_info` 字段中记录错误信息
- 不会影响设备占用流程（占用仍然会成功）
- 管理员可以在日志中查看详细错误

## 数据库更新

已提供数据库更新脚本：`update_db_add_login_info.py`

运行方式：
```bash
python3 update_db_add_login_info.py
```

脚本会：
1. 检查 `login_info` 字段是否存在
2. 如果不存在则添加该字段
3. 显示更新后的表结构

## 依赖要求

- Python 包：`paramiko` （已在 requirements.txt 中）
- 设备需要配置SSH连接信息
- 设备需要支持以下命令（大多数Linux发行版默认支持）：
  - `who` - 显示当前登录用户
  - `w` - 显示用户活动
  - `last` - 显示登录历史
  - `lastlog` - 显示用户最后登录信息

## 获取的信息包括

通过多个命令组合，系统会获取以下详细信息：

1. **当前登录用户** (who)
   - 用户名
   - 终端
   - 登录时间

2. **详细登录信息** (who -a)
   - 更详细的登录状态
   - 进程ID等

3. **用户活动** (w)
   - 当前正在执行的命令
   - 系统负载
   - 空闲时间

4. **登录历史** (last -n 30 -a)
   - 最近30次登录记录
   - 用户名
   - IP地址（重要！）
   - 登录时间
   - 登出时间
   - 登录时长

5. **用户最后登录** (lastlog)
   - 所有系统用户的最后登录时间
   - 最后登录的IP地址

## 注意事项

1. **SSH配置要求**
   - 设备必须配置至少一个SSH连接
   - SSH连接信息需要正确（IP、端口、用户名、密码）

2. **超时设置**
   - SSH连接超时设置为5秒
   - 避免长时间等待影响用户体验

3. **安全性**
   - SSH连接仅用于执行只读命令（who、w、last、lastlog）
   - 不会修改设备上的任何配置

4. **兼容性**
   - 适用于大多数Linux发行版（Ubuntu、CentOS、Debian、Red Hat等）
   - 需要设备支持SSH登录
   - 命令输出可能因Linux发行版而略有差异
